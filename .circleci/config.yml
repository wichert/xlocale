defaults: &defaults
  docker:
  - image: circleci/python:3

version: 2
jobs:
  checkout:
    <<: *defaults
    steps:
    - checkout
    - persist_to_workspace:
        root: .
        paths:
          - "*"

  build:
    docker:
    - image: quay.io/pypa/manylinux1_x86_64
    steps:
    - attach_workspace:
        at: /tmp/src
    - run:
        name: Build the wheels
        command: |
          cd /tmp/src
          for PYBIN in /opt/python/*/bin; do
            "${PYBIN}/pip" wheel . -w wheelhouse/
          done
    - run:
        name: Audit and relabel the wheels
        command: |
          cd /tmp/src
          for whl in wheelhouse/*.whl; do
            auditwheel repair "$whl" -w wheelhouse/
          done
    - persist_to_workspace:
        root: /tmp/src
        paths:
          - wheelhouse

  upload:
    <<: *defaults
    steps:
    - attach_workspace:
        at: /tmp/workspace


workflows:
  version: 2

  devel:
    jobs:
    - checkout
    - build:
        requires:
          - checkout

  release:
    jobs:
    - checkout:
        filters:
          tags:
            only: /^.*/
          branches:
            ignore: /.*/
    - build:
        filters:
          tags:
            only: /^.*/
          branches:
            ignore: /.*/
        requires:
          - checkout

    - upload:
        filters:
          tags:
            only: /^.*/
          branches:
            only: /^v.*/
        requires:
          - build


